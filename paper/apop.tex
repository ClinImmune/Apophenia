\chapter{Apophenia} \label{apop}
%@-     so lgrind will play nice with makeindex

One could divide Apophenia's functions into two categories: haphazard
convenience functions, and a unified worldview of about how data is
analyzed. Some of the convenience functions have already appeared; this
chapter describes the unified world view. 

This may also be a good place to remind the reader that, as with most of
the stats packages of the world, Apophenia has two types of
documentation: the chatty, not-comprehensive overview you are reading now and the
comprehensive function-by-function reference. The reference is autogenerated from the
source code, and can be found online at \url{http://apophenia.info/doc}
or generated from your own copy of the source using \binline{doxygen}.\footnote{doxygen is free software and is universally packaged,
so it is easy to get. If you have it installed, run \cinline{make doc} in
your source directory.}

\section{The structures}
Here is a one-sentence summary of statistical analysis: estimate the
parameters of a model
using data. Apophenia thus has three key objects defined that embody
this description, named \cinline{apop\_data}, \cinline{apop\_model}, and 
\cinline{apop\_estimate}.\footnote{Notice that the `estimate the parameters of a
model' line readily includes ``non-parametric'' models. This becomes
especially evident when coding such models, which still wind up being
black boxes that take in a data set and return a set of parameter
estimates.}

The basic story for a statistical analysis is that the researcher
assembles a data set into an \cinline{apop\_data} structure, then sends it to
an \cinline{apop\_model} so that the model's parameters can be estimated,
and that is returned in an \cinline{apop\_estimate} structure.

Supporting these main structures are a few more structures you would only
have to worry about for fine tuning.  The \cinline{apop\_name} structure is
an organized list of row and column names; functions that take an 
\cinline{apop\_data} set try to automatically handle the names for you.  The 
\cinline{apop\_inventory} structure lists the elements that an \cinline{apop\_estimate}
has generated (no model produces everything). Model estimates accept
an inventory, but all work fine if you send in NULL. Finally, the more
elaborate models, such as MLEs, require some parameters to run, in
which case you will need to fill out an \cinline{apop\_estimation\_params}
form and hand it in to the model.


\paragraph{Data}
The \cinline{apop\_data} structure adds a touch of metadata on top of the
basic \cinline{gsl\_matrix}. It includes an \cinline{apop\_name} structure (see
below), and a table for non-numeric variables. In case you need to access
its individual elements, here is the declaration:

\begin{lstlisting}
typedef struct apop_data{
    gsl_matrix  *data;
    apop_name   *names;
    char        ***categories;
    int         catsize[2];
} apop_data;
\end{lstlisting}
You can easily operate on the individual elements of the structure:
if the \cinline{matrix\_man\-ip\-u\-late} function requires a
\cinline{gsl\_ma\-trix}, but you are using an \cinline{a\-pop\_\-da\-ta}
structure, then you can call
\cinline{matrix\_man\-ip\-u\-late(my\_data-$>$data)}. Similarly to
manipulate the names and the table of text data. The size of the text
data is stored in the \cinline{catsize} element. Usage:

\begin{lstlisting}
int r,c;
apop_data   *set = get_category_data(...);
for (r=0; r< set->catsize[0]; r++){
    for (c=0; c< set->catsize[1]; c++){
        printf("%s\t", set->categories[r][c]);
    }
    printf("\n");
}
\end{lstlisting}


\paragraph{Models}
The \cinline{apop\_model} structure encapsulates a description of the world
in which the data and the parameters produce observed outcomes. The
\cinline{apop\_\-mo\-del.\-est\-i\-mate()} method takes in data and produces an \cinline{apop\_\-est\-i\-mate}. 

\marginalia{Patterns in static}{{\sl Apophenia} is a term from the
psychology literature referring to a tendency to see patterns in
static. Good data description seeks out patterns in existing data; good
hypothesis testing does not seek out patterns but aims to reject or fail
to reject observed patterns. Hypothesis testing is thus an attempt to
fight against apophenia.

The Apophenia library is so named because the word has a pleasant ring, is a
statistics-related term, and is not an acronym.}

[Many statistics packages include a model structure that describes only
linear models.  "Linear" models can include a wide range of nonlinear
features, but they are still a subset of measure zero within the class of
models as described above. Currently, Apophenia has no plans to include
a summary syntax for describing linear models; the reader who has a linear
model to be estimated via OLS or GLS is advised to instead manipulate
the data set to the appropriate form and then call \cinline{apop\_OLS} or
\cinline{apop\_GLS}.]

Frequently, a model is a probability distribution. The data is assumed
to have been drawn from a given distribution and the question is
only what distributional parameters best fit; e.g., assume the data
is Normally distributed and find the mean and variance.

In fact, one could even use the \cinline{apop\_model} to describe 
non-statistical models involving optimization subject to constraints;
see the example of section \ref{econ101}.

Because models are often distributions, and because it is not our place
to dictate what you will do with a model, the \cinline{apop\_model} also includes a
number of additional functions that may be useful for additional analyis,
such as a likelihood function that could be used for ML estimation or
for estimating the Hessian, and a random number generator. Some effort
has been made to ensure that the prepackaged models include as many of
these auxiliary functions as possible; if you are writing your own,
there is no requirement that you provide all functions, and the \cinline{apop\_maximum\_likelihood} and \cinline{apop\_numerical\_hessian}
functions do a good job of filling in blanks.

\paragraph{Estimates}
The \cinline{apop\_estimate} structure returns all the data one would want
from a regression or ML estimation, including the parameters estimated,
the variance/covariance matrix, the residuals, et cetera. The structure
includes instances of almost all of the other structures listed here, so
that you will have a link to the data, model, and estimation parameters
that produced the estimate, and an inventory of what it contains.

\paragraph{An example}
Here is a program that puts the above structures to work.  It assumes a
data set in a file, such as the \cinline{test\_data} file included with
Apophenia's source code, and that file has no row names but does have
column names.
\begin{lstlisting}
#include <apophenia/headers.h>

int main(void){
apop_data       *data;
apop_estimate   *est;
    apop_convert_text_to_db("data","d",0,1,NULL);
    data       = apop_query_to_data("select * from d");
    invent.parameters   = 1;
    est  = apop_OLS.estimate(data, NULL);
    apop_estimate_print(est);
    return 0;
}
\end{lstlisting}

We first read the data into the database, and then pull it into an \cinline{apop\_data} set. Since we didn't pare down the data, we didn't really
need the database, and could have read the text file directly into a
\cinline{apop\_data} structure:
\begin{lstlisting}
    data       = apop_text_to_data("data",0,1);
\end{lstlisting}
Then we write an \cinline{apop\_inventory} that we only want the
parameters, and to not bother finding the variance-covariance matrix or
the residuals or other such things used for hypothesis testing. Then we
send the data and the estimate to the \cinline{apop\_OLS.estimate}
function, which returns, naturally, an \cinline{apop\_estimate}
structure. Then we print it.

Feeling lazy? The program above was good form and demonstrated useful
features, but the code below will do the same thing in even fewer lines:

\begin{lstlisting}
#include <apophenia/headers.h>
int main(void){
    apop_estimate_print(apop_OLS.estimate(
         apop_text_to_data("data",0,1), NULL));
    return 0; }
\end{lstlisting}

The drawback is that the intermediate forms aren't saved, but we're busy
people who don't have time to interrogate intermediate forms anyway.

\subsection{The supporting cast}
\paragraph{Names}
The \cinline{apop\_name} structure has three components: a list of column
names, a list of row names, and a list of dependent variable names. It
is intended to accompany the \cinline{gsl\_matrix} structure, which holds
all the other information about a data aaray such as the number of rows
and columns. 

\paragraph{Inventory}
The \cinline{apop\_inventory} structure serves two purposes. It is an input
to an \cinline{apop\_model}, that tells the function what output you
would like the \cinline{apop\_estimate} output to include.  Alternatively, you
can just send in a \cinline{NULL} pointer, and the functions will return
everything apropos.

It is also an output from these functions, since the returned \cinline{apop\_estimate} will include its own \cinline{apop\_inventory},
giving a list of the elements of the structure which are
actually in use. For example, the regressions won't return a log
likelihood.

The inventory has one binary element for each element of the \cinline{apop\_estimate} structure.

If the \cinline{apop\_inventory} will be sent in to a regression/MLE
function, set the appropriate element to either zero or one if you would
like the function to return the designated \cinline{apop\_estimate} element.

The \cinline{apop\_estimate} structure itself has an \cinline{apop\_inventory}
element named \cinline{uses} embedded within it. Those elements for
which \cinline{uses.elmt} are zero are unallocated pointers (so be careful:
precede any pointer use with an \cinline{if(est->uses.element)} clause).

It may sometimes be useful to manipulate the \cinline{apop\_estimate} structure's
internal \cinline{apop\_inventory} element to your own benefit. For
example, if you set \cinline{est-$>$uses.residuals = 0} before calling
\cinline{apop\_print\_estimate(est, NULL)}, then the residuals won't get
printed. But be careful: if you then call \cinline{apop\_estimate\_free(est)},
then the residuals won't get freed, either.

\paragraph{Estimate parameters}
The \ttind{apop\_estimation\_params} are the details for how an \cinline{a\-pop\_\-est\-i\-mate} should do its work; currently it is just the specifications
for tolerances, step sizes, starting points, et cetera, for \cinline{apop\_\-max\-i\-mum\_\-like\-li\-hood}.

\section{Estimating a model}
Here are the models that currently ship with Apophenia:\\
\cinline{apop\_exponential} and \cinline{apop\_\-exp\-o\-nen\-tial\_\-rank}, \\
\cinline{apop\_gamma} and \cinline{apop\_gamma\_rank}, \\
\cinline{apop\_GLS}, \\
\cinline{apop\_normal} (or \cinline{apop\_gaussian}, as you prefer), \\
\cinline{apop\_OLS}, \\
\cinline{apop\_poisson}, \\
\cinline{apop\_probit}, \\
\cinline{apop\_waring} and \cinline{apop\_waring\_rank}, \\
\cinline{apop\_yule}, \\
\cinline{apop\_zipf} and \cinline{apop\_zipf\_rank}.

Some of these are full models, some are distributions, some are
estimated via closed-form calculations and some via MLEs. However, all
of them can be estimated via a form such as
\begin{lstlisting}
apop_normal.estimate(data,  NULL);
\end{lstlisting}

The two optional parameters, the ones that were \cinline{NULL} above,
are an \cinline{apop\_inv\-ent\-ory} and an
\cinline{apop\_\-est\-i\-ma\-tion\_\-par\-a\-met\-ers}.


\section{Output and interrogating an estimate}
Now that you have run an estimation function to produe an 
\cinline{apop\_\-est\-i\-mate}, you want to ask it some questions. Only the most
basic hypothesis tests are included in the estimate (and future versions
of Apophenia have a good chance of extricating them). Instead, you can
pass the estimate object to a function that will test a hypothesis. For
example, the \ttind{apop\_estimate\_F\_test} takes in an 
\cinline{apop\_estimate} and puts out the result of an F test, and the
\ttind{apop\_estimate\_correlation\_coefficient} will produce a
table including \ind{$R^2$}, adjusted $R^2$, \ind{SSE}, SST, and SSR. [See the
reference for the definitions.]

The output is an \cinline{apop\_data} structure. Typically, the rows are
names of the variables in your original data set, and the columns are
statistics. Note that this means what had been a column name in the 
original data set is now a row name.

\paragraph{Output} 
But you don't just want to know that an \cinline{apop\_data} set has been
produced, you want to {\sl see} it.  Most of the useful data types have
a print function, and given the package-type-operation naming scheme,
you can basically guess their names: \ttind{apop\_\-da\-ta\_\-print},
\ttind{apop\_\-ma\-trix\_\-print}, \ttind{apop\_\-vec\-tor\_\-print}. If your
data is primarily integers, you may want to save screen real estate
with the integer-printing versions: \ttind{apop\_data\_print\_int},
\ttind{apop\_matrix\_print\_int}, \ttind{apop\_vector\_print\_int}.

These printing functions are actually three-in-one functions: you can
dump your data to either the screen, a file, or the database. You select
the output via the \ttind{apop\_opts} structure, which is where all of
Apophenia's global options are stored. 

The three choices for the \index{apop\_opts!output\_type@\cinline{output\_type}}\cinline{apop\_opts.output\_type} 
variable are:
\begin{lstlisting}
apop_opts.output_type   = 's';  //default: print to screen.
apop_opts.output_type   = 'f';  //print to file.
apop_opts.output_type   = 'd';  //store in database.
\end{lstlisting}

The screen output will generally be human-readable, meaning different
column sizes and other notes and conveniences for you at the terminal to
understand what is going on.
The file output will generally be oriented toward allowing a machine to
read the output, meaning stricter formatting. 

The second argument to the output functions is a string.  Output to
screen ignores this; if outputting to file, this is the file name;
if writing to the database, then this will be the table name.
If outputting to file, the name can be \cinline{NULL}, in which case, the
output will be printed to STDOUT (if you aren't familiar with STDOUT,
then it is the screen), but in the machine-friendly format instead of
the human-friendly form. This is what you will use if you are piping
output from an Apophenia-based program to another program.

Since the name argument is irrelevant to printing to screen, and
Apophenia endeavors to facilitate laziness, there are functions
corresponding to the above \cinline{apop\_type\_print} functions that will
dump to the screen, by basically just setting the output type to \cinline{'s'}, e.g.:
\ttindex{apop\_vector\_print} \ttindex{apop\_vector\_print\_int}
\ttindex{apop\_matrix\_print} \ttindex{apop\_matrix\_print\_int}
\ttindex{apop\_data\_print} \ttindex{apop\_data\_print\_int}
\begin{lstlisting}
apop_vector_show(a_vector);
apop_matrix_show_int(a_matrix);
apop_data_show_int(data);
\end{lstlisting}

\section{Command-line utilities}
Incidentally, Apophinia includes a handful of \ind{command-line utilities} for
situations where there is no need to write a full-blown C program. For
all of the utilities below, you can use the \binline{-h} parameter to
get detailed instructions (e.g., \binline {apop\_\-db\_\-to\_\-cross\-tab -h}
Three are simply for handling SQLite databases.

\ttind{apop\_\-text\_\-to\_\-db} reads a text file into a database table,
\ttind{apop\_\-merge\_\-dbs} will send tables from one database to
another, and
\ttind{apop\_\-db\_\-to\_\-cross\-tab} will take a table from the SQLite
database and produce a crosstab. All of these are simply wrappers for
the corresponding Apophenia functions, as seen in Chapter \ref{sql}.

One final command: \binline{apop} is a program that provides a
server/client for doing data analysis. In theory, it will allow users to
do analyses from the command line or from other languages such as Perl
or Python. At the moment, it remains in the proof-of-concept stage;
watch this space for updates.
