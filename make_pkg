junkdir=dists
pkg=apophenia
version=0.22
date=`date +%d_%b_%y`

#See README for notes.

#This script copies everything into a junk directory, that GNU's 
#prep materials will produce a thousand temp files in, concluding 
#with a file named apophenia-N.NN.tar.gz. Once that it is ready
#for distribution, the tar.gz arcive is copied to the main directory
#and this junk directory is erased. 
#If the appropriate tools are available, it also produces Debian pkgs.
#Finally, the script unzips the archive and compiles from the archive.

rm -rf $junkdir
mkdir $junkdir
mkdir $junkdir/$pkg-$version
cp -rf * $junkdir/$pkg-$version
cd $junkdir/$pkg-$version
cp install/* .
mv Readme.user README
cp ChangeLog NEWS
sed -i "s/X\.XX/$version/" README apop_db.c configure.ac
sed -i -f prep_variadics.sed *c *h model/*c model/*h
	#add a directory with links to all headers:
	mkdir apophenia
	cd apophenia
		cp ../*.h ./        #linking won't work for Windows
		cp ../vasprintf/*.h ./
		cp ../model/*.h ./
		#ln -s ../*.h ./
		#ln -s ../vasprintf/*.h ./
		#ln -s ../model/*.h ./
		cd ..
	#let the GNU prep everything and produce a distribution pkg.
	libtoolize
    	aclocal
	autoconf 
	autoheader
	automake -a
	./configure --enable-python
#    yes | dh_make -l -n -c GPL  
#    cp ../../debian_control debian/control
#    cp ../../debian_copyright debian/copyright
#    debuild -us -uc 
#    rm ../$pkg-$version.tar.gz
	make dist
    mv apophenia-$version.tar.gz ../apophenia-$version-$date.tgz 

#rm -rf $junkdir
echo "***********tgz done; now prepping Debian package*********************"
#Prerequisites: You will need the debian build tools; try:
# apt-get install dpkg-dev debhelper devscripts fakeroot linda dh-make 
#tar xz < apophenia-$version-#date.tar.gz


    #Uncomment the following to install from source
#cd $pkg-$version
#	sudo make install
#cd ..
    #Uncomment the following to install from debian pkg
	#sudo apt-get install apophenia-$version.deb
#mkdir dists
#mv apophenia-*.deb dists
#mv apophenia-*.gz dists
#mv apophenia_* dists


echo "***********Done with packing; now compiling***********"
cd $pkg-$version
./configure; make


echo "***********Debianizing***********"
mkdir deb
cd deb

mkdir -p i/usr/include
mkdir i/DEBIAN
cp ../../../deb.copyright i/DEBIAN
cp ../../../deb.control i/DEBIAN/control
cp -rf ../apophenia i/usr/include
cp ../apop.h i/usr/include
mkdir i/usr/bin
mkdir i/usr/lib
/bin/bash ../libtool --mode=install /usr/bin/install -c ../libapophenia.la `pwd`/i/usr/lib/libapophenia.la
cp ../apop_text_to_db i/usr/bin/apop_text_to_db
cp ../apop_db_to_crosstab i/usr/bin/apop_db_to_crosstab
cp ../apop_plot_query i/usr/bin/apop_plot_query
cp ../apop_merge_dbs i/usr/bin/apop_merge_dbs
dpkg -b i ../../libapophenia-$version-0.deb
